---
title: "STAT 333 Project Two"
Author1: "Xinyi Yu  xyu286@wisc.edu"
Author2:  "Xiu Xie   @wisc.edu"
Authour3: "Yuhan Xie   xie75@wisc.edu"  
Author4: "Yuwen Zhang  zhang924@wisc.edu"
date: 04/20/2019
output: html_document
---


```{r}
library(readr)
library(stringr)

rm(list = ls())
chart = read_csv("train_Madison.csv")
origin_data = chart
#head(chart)
```

```{r}
chart = origin_data
l<-rep(0, 500) #cor of each predictor with star
predictor_data = chart[,9:508]
for (i in 1:500){
  l[i] = cor(chart$star, predictor_data[,i])
}

most = names(predictor_data[order(l[1:500]) < 51])
least = names(predictor_data[order(l[1:500]) > 451])
not_important = names(predictor_data[order(l[1:500]) < 400 & order(l[1:500]) > 100])

data_transform = function(data = chart, test = FALSE, eliminate = TRUE, portion = TRUE, city = FALSE, origin = chart) {
  #find the most positive and negative words
  
  data = data[colnames(data) != "chicago" & colnames(data) != "wisconsin"]
  #eliminate unimportant variables
  if(eliminate == TRUE){
    data = data[!(colnames(data) %in% not_important)]
  }

  #calculate the number of extreme words
  most_sum = apply(data[,most], MARGIN = 1, FUN = sum)
  least_sum = apply(data[,least], MARGIN = 1, FUN = sum)
  
  data$dots_count = rep(0, nrow(data))
  data$capital = rep(0, nrow(data))
  trim = ((which(colnames(data) == "nword"))+1):length(data)
  
  
  data$portion = (most_sum+1) / (least_sum+1)
  data$exclam = rep(0, nrow(data))
  data$question = rep(0, nrow(data))
  
  
  
  for(i in 1:nrow(data)){
    text = data$text[i]
    
    #create dummy for city names
    if(city == TRUE) {
      if(test == FALSE) {
        if(!(data$city[i] %in% colnames(data))){
          data$new_col = rep(0, nrow(data))
          colnames(data)[length(data)] = data$city[i]
        }
        data[i, colnames(data) == data$city[i]] = 1
      }
      if(test == TRUE){
        if((data$city[i] %in% colnames(origin))){
          data[i, colnames(data) == data$city[i]] = 1
        }
      }
    }
    #---------------------------
    
    #count punctuations
    data$exclam[i] = str_count(text, pattern = "!")
    data$question[i] = str_count(text, pattern = "\\?")
    data$dots_count[i] = str_count(text, pattern = "\\.")
    data$capital[i] = str_count(text, pattern = "[ABCDEFGHIJKLMNOPQRSTUVWXYZ]")
  }
  
  #transform all count of words to portion of text
  if(portion == TRUE){
    data[trim] = data[trim] / data$nword
  }
  
  return(data)
}


transformed_data = data_transform(chart, eliminate = FALSE, portion = TRUE)
trim = (which(colnames(transformed_data) == "nchar")):length(transformed_data)
#head(transformed_data)
transformed_data[,(length(transformed_data) - 20):length(transformed_data)]
chart = transformed_data
```


```{r}
model1 = lm(star ~ ., data = chart[c(2,trim)])
yhat = predict(model1)
yhat[yhat > 5] = 5
yhat[yhat < 1] = 1
resid = chart$star - yhat
SSE = sum(resid^2)
SSE
summary(model1)$p_value
plot(chart$Id, resid, xlab = "ID", ylab = "Residuals", main = "Residual Plot",pch = 23,bg = "red",cex = 1.2)
abline(a = 0, b = 0, col = "black", lwd = 3)
sortResid = sort(abs(resid), decreasing = TRUE)
Outlier = sortResid[1:100]
Outlier
```
  
```{r}
par(mfrow = c(1,2))
hist(resid, breaks = 100, main="Histogram of Residuals", xlab = "Residuals")
plot(density(resid), main="Kernel Density of Residuals", xlab = "Residuals")
```

```{r}
coefSum = rep(0, ncol(chart[trim]))
interSum = 0
count = 0
for (i in 1:100){
  list = sample(x = 1:nrow(chart), size = 10000)
  model.random = lm(star ~ ., data = chart[list, c(2, trim)])
  if(length(summary(model.random)$coefficients[-1,1]) == length(trim)){
    coefSum = coefSum + summary(model.random)$coefficients[-1,1]
    interSum = interSum + summary(model.random)$coefficients[1,1]
    count = count + 1
  }
  else{
    tail(summary(model.random))
  }
}
fitRaw = data.matrix(chart[trim]) %*% data.matrix(coefSum/count)
fitRaw = fitRaw + interSum/count
fitRaw[fitRaw > 5] = 5
fitRaw[fitRaw < 1] = 1
residNew = chart$star - fitRaw
SSENew = sum(residNew^2)
SSENew
#model1 = lm(star ~ ., data = rawdata)
#summary(model1)
#trim = which(summary(model1)$coefficients[,4] < 1)
#model2 = lm(star ~ ., data = rawdata[trim])
#summary(model2)

```


```{r}
test_data = read_csv("test_Madison.csv")
head(test_data)
test_data = data_transform(test_data, eliminate = FALSE, portion = TRUE, test = TRUE, origin = chart)
trim = (which(colnames(test_data) == "nchar")):length(test_data)
```

```{r}
fit_data = data.matrix(test_data[trim]) %*% data.matrix(coefSum/count)
fit_data = fit_data + interSum/count
fit_data[fit_data > 5] = 5
fit_data[fit_data < 1] = 1
result = as.data.frame(test_data[,1])
colnames(result)[1] = "Id"
result$Expected = fit_data
result
write.csv(result, "test_result.csv", row.names = FALSE)
```
