---
title: "STAT 333 Project Two"
Author1: "Xinyi Yu  xyu286@wisc.edu"
Author2:  "Xiu Xie   @wisc.edu"
Authour3: "Yuhan Xie   xie75@wisc.edu"  
Author4: "Yuwen Zhang  zhang924@wisc.edu"
date: 04/20/2019
output: html_document
---


```{r}
library(readr)
library(stringr)

rm(list = ls())
chart = read_csv("train_Madison.csv")
#origin_data = chart
#head(chart)
```

```{r}
#chart = origin_data

#pos_new = scan("new_words.txt", what = character())

data_transform = function(data = chart, test = FALSE, portion = TRUE, create = TRUE, origin = chart) {
  data = data[colnames(data) != "chicago" & colnames(data) != "wisconsin"]
  colnames(data)[colnames(data) == "name"] = "NAME"
  colnames(data)[colnames(data) == "city"] = "CITY"
  colnames(data)[colnames(data) == "text"] = "TEXT"
  colnames(data)[colnames(data) == "star"] = "STAR"
  if(create == TRUE){
    data = data[1:which(colnames(data) == "nword")]
    if(test == TRUE){
      for(i in (which(colnames(origin) == "nword")+1):length(origin)){
        data$new_col = rep(0, nrow(data))
        colnames(data)[ncol(data)] = colnames(origin)[i]
      }
    }
  }
  
  data$exclam_mark = rep(0, nrow(data))
  data$question_mark = rep(0, nrow(data))
  data$dots_count = rep(0, nrow(data))
  data$capital_letter = rep(0, nrow(data))
  for(i in 1:nrow(data)){
    if(i%%1000 == 0){
      print(i)
      if(test == FALSE){
        delete_index = c()
        for(j in (which(colnames(data) == "nword")+1):length(data)){
          if(sum(data[j]) < 0.005*i)
            delete_index = c(delete_index, j)
        }
        data = data[-delete_index]
        print(length(data))
      }
    }
    
    text = data$TEXT[i]
    #---------------------------
    if(create == TRUE && test == FALSE){
      words = str_extract_all(tolower(text), "[a-z]+")
      for(j in 1:length(words[[1]])){
        if(!(words[[1]][j] %in% colnames(data))){
          data$new_col = rep(0, nrow(data))
          data$new_col[i] = 1
          colnames(data)[ncol(data)] = words[[1]][j]
        }else{
          data[i, which(colnames(data) == words[[1]][j])] = data[i, which(colnames(data) == words[[1]][j])] + 1
        }
      }
    }
    if(create == TRUE && test == TRUE){
      words = str_extract_all(tolower(text), "[a-z]+")
      for(j in 1:length(words[[1]])){
        if(words[[1]][j] %in% colnames(data)){
          data[i, which(colnames(data) == words[[1]][j])] = data[i, which(colnames(data) == words[[1]][j])] + 1
        }
      }
    }
    
    #count punctuations
    data$exclam_mark[i] = str_count(text, pattern = "!")
    data$question_mark[i] = str_count(text, pattern = "\\?")
    data$dots_count[i] = str_count(text, pattern = "\\.")
    data$capital_letter[i] = str_count(text, pattern = "[ABCDEFGHIJKLMNOPQRSTUVWXYZ]")
  }
  
  if(test == FALSE){
    delete_index = c()
    for(j in (which(colnames(data) == "nword")+1):length(data)){
      if(sum(data[j]) < 0.005*length(data))
        delete_index = c(delete_index, j)
    }
    data = data[-delete_index]
    print(length(data))
  }
  
  
  #find the most influencial predictors
  if(test == TRUE){
    trim = ((which(colnames(data) == "nword"))+1):length(data)
  }else{
    trim = ((which(colnames(data) == "nword"))+1):length(data)
  }
  
  if(test == TRUE){
    l<-rep(-100, length(origin)) #cor of each predictor with star
    for (i in ((which(colnames(origin) == "dots_count"))+1):length(origin)){
      l[i] = cor(origin$STAR, origin[,i])
    }
  }else{
    l<-rep(-100, length(data)) #cor of each predictor with star
    for (i in ((which(colnames(data) == "dots_count"))+1):length(data)){
      l[i] = cor(data$STAR, data[,i])
    }
  }
  l = l[l!=-100]

  #calculate the number of extreme words
  most = names(data[which(rank(l) > length(data)- 100) + (which(colnames(data) == "dots_count"))])
  least = names(data[which(rank(l) <101) + (which(colnames(data) == "dots_count"))])
 
  most_sum = apply(data[,most], MARGIN = 1, FUN = sum)
  least_sum = apply(data[,least], MARGIN = 1, FUN = sum)
  #-----------------------
  
  data$PORTION = (most_sum+1) / (least_sum+1)
  
  data$PORTION
  #transform all count of words to portion of text
  if(portion == TRUE){
    data[trim] = data[trim] / data$nword
  }
  return(data)
}

add_predictor = function(data = chart, new_pred, col_name, portion = TRUE){
  if(col_name %in% colnames(chart)){
    return(data)
  }
  data$new_col = rep(0, nrow(data))
  colnames(data)[ncol(data)] = col_name
  for(i in 1:nrow(data)){
    data[i, ncol(data)] = str_count(tolower(data$TEXT[i]), new_pred)
    if(portion == TRUE){
      data[i, ncol(data)] = data[i, ncol(data)] / data$nword[i]
    }
  }
  return(data)
}


test_predictor = chart
test_predictor = add_predictor(data = test_predictor, "omg", "omg")
test_predictor = add_predictor(data = test_predictor, ":\\)", "smile_face")
test_predictor = add_predictor(data = test_predictor, ";\\)", "wink_face")
test_predictor = add_predictor(data = test_predictor, "wtf", "wtf")
test_predictor = add_predictor(data = test_predictor, "fuck", "fuck")
test_predictor = add_predictor(data = test_predictor, "shit", "shit")
test_predictor = add_predictor(data = test_predictor, "\\$", "dollar_sign")
test_predictor = add_predictor(data = test_predictor, "1", "1")
test_predictor = add_predictor(data = test_predictor, "2", "2")
test_predictor = add_predictor(data = test_predictor, "3", "3")
test_predictor = add_predictor(data = test_predictor, "4", "4")
test_predictor = add_predictor(data = test_predictor, "5", "5")
test_predictor = add_predictor(data = test_predictor, "minus", "minus")
test_predictor = add_predictor(data = test_predictor, "\\+", "add_mark")
test_predictor = add_predictor(data = test_predictor, "\\-", "minus_mark")
write.csv(test_predictor, "train_1505_added.csv", row.names = FALSE)

for(i in ((which(colnames(test_predictor) == "nword"))+1):length(test_predictor)){
  if(sum(test_predictor[i] * data$nword[i])<50){
    print(colnames(test_predictor)[i])
  }
}

chart = test_predictor


sum(test_predictor[,"minus"])
sum(test_predictor[,"5"])
sum(test_predictor[,"4"])
sum(test_predictor[,"3"])
sum(test_predictor[,"2"])
sum(test_predictor[,"1"])
sum(test_predictor[,"$"])
sum(test_predictor[,":)"])
sum(test_predictor[,";)"])
sum(test_predictor[,"omg"])
sum(test_predictor[,"wtf"])
sum(test_predictor[,"fuck"])
sum(test_predictor[,"shit"])

head(test_predictor[(length(test_predictor)-40):length(test_predictor)])

chart = data_transform(chart, portion = TRUE)
trim = (which(colnames(chart) == "nchar")):length(chart)
head(chart)
```


```{r}
model1 = lm(STAR ~ . , data = chart[c(2,trim)])
#summary(model1)$coefficients[-1,4]
yhat = predict(model1)
yhat[yhat > 5] = 5
yhat[yhat < 1] = 1
resid = chart$STAR - yhat
SSE = sum(resid^2)
SSE
summary(model1)$p_value
plot(chart$Id, resid, xlab = "ID", ylab = "Residuals", main = "Residual Plot",pch = 23,bg = "red",cex = 1.2)
abline(a = 0, b = 0, col = "black", lwd = 3)
sortResid = sort(abs(resid), decreasing = TRUE)
Outlier = sortResid[1:100]
Outlier
```
  
```{r}
par(mfrow = c(1,2))
hist(resid, breaks = 100, main="Histogram of Residuals", xlab = "Residuals")
plot(density(resid), main="Kernel Density of Residuals", xlab = "Residuals")
```

```{r}
coefSum = rep(0, ncol(chart[trim]))
interSum = 0
count = 0

for (i in 1:100){
  print(i)
  list = sample(x = 1:nrow(chart), size = 5000)
  model.random = lm(STAR ~ ., data = chart[list, c(2, trim)])
  if(length(summary(model.random)$coefficients[-1,1]) == length(trim)){
    coefSum = coefSum + summary(model.random)$coefficients[-1,1]
    interSum = interSum + summary(model.random)$coefficients[1,1]
    count = count + 1
  }
  #else{
    #tail(summary(model.random))
  #}
}
fitRaw = data.matrix(chart[trim]) %*% data.matrix(coefSum/count)
fitRaw = fitRaw + interSum/count
fitRaw[fitRaw > 5] = 5
fitRaw[fitRaw < 1] = 1
residNew = chart$star - fitRaw
SSENew = sum(residNew^2)
SSENew

```


```{r}
test_data = read_csv("test_Madison.csv")
test_data = data_transform(test_data, portion = TRUE, test = TRUE, origin = chart)

write.csv(test_transformed, "test_1504_predictor.csv", row.names = FALSE)
trim = (which(colnames(test_data) == "nchar")):length(test_data)
```

```{r}
count = 1
test_data$portion
coefSum = summary(model1)$coefficients[-1,1]
coefSum
interSum = summary(model1)$coefficients[1,1]
interSum
test_data[trim]

fit_data = data.matrix(test_data[trim]) %*% data.matrix(coefSum/count)
fit_data = fit_data + interSum/count
fit_data[fit_data > 5] = 5
fit_data[fit_data < 1] = 1
result = as.data.frame(test_data[,1])
colnames(result)[1] = "Id"
result$Expected = fit_data
result
write.csv(result, "test_result.csv", row.names = FALSE)
```
